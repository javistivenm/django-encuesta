<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Portal administrativo</title>
    <style>
        :root {
            --fondo: #eef4fa;
            --panel: #ffffff;
            --borde: #d8e3ef;
            --texto: #10243a;
            --subtexto: #49607a;
            --acento: #0f766e;
            --acento-2: #0ea5a4;
        }
        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: "Segoe UI", "Noto Sans", sans-serif;
            color: var(--texto);
            background: linear-gradient(120deg, #ecfeff 0%, var(--fondo) 35%);
        }
        .wrapper { max-width: 1180px; margin: 28px auto; padding: 0 16px; }
        .panel {
            background: var(--panel);
            border: 1px solid var(--borde);
            border-radius: 14px;
            padding: 18px;
            margin-bottom: 16px;
        }
        h1 { margin: 0 0 8px; }
        .muted { color: var(--subtexto); margin: 0; }
        .grid { display: grid; gap: 12px; }
        .grid-filtros { grid-template-columns: repeat(5, minmax(0, 1fr)); }
        .grid-kpi { grid-template-columns: repeat(3, minmax(0, 1fr)); }
        .kpi { background: #f8fcff; border: 1px solid var(--borde); border-radius: 12px; padding: 12px; }
        .kpi .label { color: var(--subtexto); font-size: 0.9rem; }
        .kpi .valor { font-size: 1.4rem; font-weight: 700; margin-top: 6px; }
        label { display: block; font-size: 0.88rem; color: var(--subtexto); margin-bottom: 6px; }
        input, select {
            width: 100%;
            border: 1px solid var(--borde);
            border-radius: 10px;
            padding: 9px 10px;
            font-size: 0.95rem;
        }
        .acciones { margin-top: 12px; display: flex; gap: 10px; flex-wrap: wrap; }
        .btn {
            border: none;
            border-radius: 10px;
            padding: 11px 14px;
            font-weight: 700;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn-primary { color: #fff; background: linear-gradient(120deg, var(--acento), var(--acento-2)); }
        .btn-secondary { color: var(--texto); background: #fff; border: 1px solid var(--borde); }
        table { width: 100%; border-collapse: collapse; font-size: 0.93rem; }
        th, td { border-bottom: 1px solid var(--borde); padding: 9px 6px; text-align: left; }
        th { color: var(--subtexto); font-weight: 700; }
        .ranking-list { margin: 0; padding-left: 18px; }
        .ranking-list li { margin: 5px 0; }
        @media (max-width: 980px) {
            .grid-filtros { grid-template-columns: repeat(2, minmax(0, 1fr)); }
            .grid-kpi { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        }
        @media (max-width: 620px) {
            .grid-filtros, .grid-kpi { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <main class="wrapper">
        <section class="panel">
            <h1>Portal administrativo</h1>
            <p class="muted">Consulta de resultados, indicadores y exportacion de encuestas.</p>
        </section>

        <section class="panel">
            <form method="get">
                <div class="grid grid-filtros">
                    <div>
                        <label for="id_fecha_inicio">Fecha inicio</label>
                        <input id="id_fecha_inicio" type="date" name="fecha_inicio" value="{{ filtros.fecha_inicio }}">
                    </div>
                    <div>
                        <label for="id_fecha_fin">Fecha fin</label>
                        <input id="id_fecha_fin" type="date" name="fecha_fin" value="{{ filtros.fecha_fin }}">
                    </div>
                    <div>
                        <label for="id_sede">Sede</label>
                        <select id="id_sede" name="sede">
                            <option value="">Todas</option>
                            {% for sede in sedes %}
                                <option value="{{ sede.id }}" {% if filtros.sede_id == sede.id|stringformat:"s" %}selected{% endif %}>{{ sede.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label for="id_comedor">Comedor</label>
                        <select id="id_comedor" name="comedor">
                            <option value="">Todos</option>
                            {% for comedor in comedores %}
                                <option value="{{ comedor.id }}" {% if filtros.comedor_id == comedor.id|stringformat:"s" %}selected{% endif %}>{{ comedor.sede.nombre }} - {{ comedor.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label for="id_turno">Turno</label>
                        <select id="id_turno" name="turno">
                            <option value="">Todos</option>
                            <option value="sin_turno" {% if filtros.turno_id == 'sin_turno' %}selected{% endif %}>Sin turno</option>
                            {% for turno in turnos %}
                                <option value="{{ turno.id }}" {% if filtros.turno_id == turno.id|stringformat:"s" %}selected{% endif %}>{{ turno.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="acciones">
                    <button class="btn btn-primary" type="submit">Aplicar filtros</button>
                    <a class="btn btn-secondary" href="{% url 'encuestas:portal_inicio' %}">Limpiar filtros</a>
                    <a class="btn btn-secondary" href="{% url 'encuestas:portal_exportar_csv' %}{% if querystring %}?{{ querystring }}{% endif %}">Exportar CSV</a>
                </div>
            </form>
        </section>

        <section class="panel">
            <div class="grid grid-kpi">
                <article class="kpi">
                    <div class="label">Encuestas registradas</div>
                    <div class="valor">{{ respuestas_total }}</div>
                </article>
                <article class="kpi">
                    <div class="label">Promedio satisfaccion general</div>
                    <div class="valor">{{ promedios.promedio_satisfaccion_general|default:'-'|floatformat:2 }}</div>
                </article>
                <article class="kpi">
                    <div class="label">Promedio calidad</div>
                    <div class="valor">{{ promedios.promedio_calidad|default:'-'|floatformat:2 }}</div>
                </article>
                <article class="kpi">
                    <div class="label">Promedio variedad</div>
                    <div class="valor">{{ promedios.promedio_variedad|default:'-'|floatformat:2 }}</div>
                </article>
                <article class="kpi">
                    <div class="label">Promedio limpieza</div>
                    <div class="valor">{{ promedios.promedio_limpieza|default:'-'|floatformat:2 }}</div>
                </article>
                <article class="kpi">
                    <div class="label">Promedio tiempo atencion</div>
                    <div class="valor">{{ promedios.promedio_tiempo|default:'-'|floatformat:2 }}</div>
                </article>
            </div>
        </section>

        <section class="panel">
            <h2>Ranking de comedores</h2>
            {% if ranking_comedores %}
                <ol class="ranking-list">
                    {% for item in ranking_comedores %}
                        <li>
                            {{ item.comedor__sede__nombre }} - {{ item.comedor__nombre }}:
                            promedio {{ item.promedio|floatformat:2 }} ({{ item.total }} encuestas)
                        </li>
                    {% endfor %}
                </ol>
            {% else %}
                <p class="muted">No hay datos para el ranking con los filtros actuales.</p>
            {% endif %}
        </section>

        <section class="panel">
            <h2>Listado de comentarios</h2>
            {% if comentarios %}
                <table>
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Sede</th>
                            <th>Comedor</th>
                            <th>Turno</th>
                            <th>Comentario</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for respuesta in comentarios %}
                            <tr>
                                <td>{{ respuesta.fecha_hora_registro|date:'Y-m-d H:i' }}</td>
                                <td>{{ respuesta.sede.nombre }}</td>
                                <td>{{ respuesta.comedor.nombre }}</td>
                                <td>{% if respuesta.turno %}{{ respuesta.turno.nombre }}{% else %}-{% endif %}</td>
                                <td>{{ respuesta.comentario }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p class="muted">No hay comentarios para los filtros seleccionados.</p>
            {% endif %}
        </section>
    </main>
</body>
</html>
